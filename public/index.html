<html>

<head>
    <title>Boter Kaas en Eieren</title>
    <link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/components/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" href="/app.css" />
</head>

<body>
    <div id="app"></div>

    <script src="/components/jquery/dist/jquery.min.js"></script>
    <script src="/components/nunjucks/browser/nunjucks.min.js"></script>
    <script src="/components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script>
        var playfield = []
        var rslt = {status:"playing", turn: false} //dit moet opgehaald worden uit de server en niet hardcoded
        var Home = {
            fetch: function() {
                //ophalen data
                $.ajax({
                    url: "/playfield",
                    success: function(playfield) {

                        $("#app").html(nunjucks.render("/templates/home.html", {
                            playfield: playfield
                        }))
                        playfield = playfield
                        Home.createChecker()
                    },
                })
            },

            createChecker: function() {
                Home.checker = setInterval(function() {
                    if ($("#home").length > 0) {
                        clearInterval(Home.checker)
                        Home.bind();
                    }
                }, 10)
            },
            bind: function() {
                if(rslt.turn === false){
                    console.log("p1");
                    $(".block").click(function(e) {
                        const rowp = (this).dataset.row
                        const colp = (this).dataset.column

                        Home.turn(rowp, colp)
                        rslt.turn = true
                        Home.fetch()
                    })
                }
                else if (rslt.turn === true) {
                    console.log("p2");
                    const rowc = Home.randomRowOrCol(0,2)
                    const colc = Home.randomRowOrCol(0,2)

                    Home.turn(rowc, colc)
                    rslt.turn = false
                    Home.fetch()
                }
                $(".restart").click(function(e) {
                    $.ajax({
                        method: "DELETE",
                        url: "/turn",
                        success: function(playfield) {
                            for (var i = 0; i < playfield.length; i++) {
                                for (var j = 0; j < playfield.length; j++) {
                                    if ($("div.block.col-xs-4.blocks[data-row='" + i + "'][data-column='" + j + "']").hasClass("fa fa-times")) {
                                        $("div.block.col-xs-4.blocks[data-row='" + i + "'][data-column='" + j + "']").removeClass("fa fa-times")
                                    }
                                    if ($("div.block.col-xs-4.blocks[data-row='" + i + "'][data-column='" + j + "']").hasClass("fa fa-circle-o")) {
                                        $("div.block.col-xs-4.blocks[data-row='" + i + "'][data-column='" + j + "']").removeClass("fa fa-circle-o")
                                    }
                                }
                            }
                            rslt.status = "playing"
                            Home.fetch()
                        },
                    })
                })
            },
            turn : function(row, col){
                if (rslt.status !== "ended"){

                    $.ajax({
                        method: "POST",
                        url: "/turn",
                        data: {
                            row: row,
                            col: col
                        },
                        success: function(result) {
                            if (result.status === "ended") {
                                $("#app").html(nunjucks.render("/templates/home.html", {
                                    playfield: playfield,
                                    result : result
                                }))
                                rslt = result
                            }
                            if (result.winner === "draw") {
                                alert("Gelijkspel!");
                            } else if (result.winner === "X") {
                                alert("Player 1 wint!");
                            } else if (result.winner === "O") {
                                alert("Player 2 wint!");
                            }
                        },
                    })
                }
            },
            //random getal tussen 0 en 2(om positie te bepalen[row,col])
            randomRowOrCol : function(min, max){
                return Math.floor(Math.random()*(max-min+1)+min)
            },
            render: function() {
                Home.fetch()
            }
        }
        Home.render()
    </script>
</body>

</html>
